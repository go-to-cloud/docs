# 管理模块

> 阅读时间大约需要10分钟

项目列表中有一项`管理模块`，如下图所示

![管理模块](/assets/project_modules.png)

> 从左到右依次是: `代码仓库`, `持续集成`, `持续部署`, `制品仓库`

## 代码仓库

代码仓库是项目中代码的来源，一个项目通常是由一个或多个代码仓库来实现

点击代码仓库图标，可以看到已导入项目中的仓库，如果需要导入新的代码仓库，可以点击右上角`导入代码仓库`按钮进行

:::info 注意
可以被导入的代码仓库都是在`配置环境 - 代码仓库`中绑定过的代码仓库
:::


### 导入代码仓库

![导入代码仓库](/assets/project_code_import.png)

::: tip
如上图所示，可以导入项目有关的所有代码仓库后再点击`关闭`按钮
:::

### 代码仓库列表

![代码仓库列表](/assets/project_code_list.png)

:::tip
点击代码仓库地址可以跳转到git仓库
:::

`移除代码仓库` 仅仅是将代码仓库从项目中移除，代码不会受到任何影响，如果需要，可以重新导入代码仓库

## 持续集成

持续集成(`CI`)，在GTC中又称为`构建计划`（同类产品中也叫作流水线），作用是将指定代码分支编译打包为镜像后发布到`制品仓库`

:::tip
一个项目中往往会有多个构建计划，比如`开发阶段`、`测试阶段`、`预发阶段`等，这些不同的阶段往往对应不同的代码分支

`生产阶段`一般不会单独创建构建计划，而是使用预发阶段的镜像作为生产环境的镜像
:::

### 创建构建计划

![创建构建计划](/assets/project_build_new.png)

每个构建计划均由以下四步组成

#### Step 1. 选择构建环境，并填写计划名称

![step1](/assets/project_build_step1.png)

:::tip 构建环境
构建环境是指编译、打包代码的系统环境，本质上就是用于创建Docker镜像的基础镜像

`GTC`内置了`.Net`、`Golang`、`Java`、`NodeJS`作为基础构建环境
:::

> 如果内置的环境无法满足需求，可以在`输入栏`中输入基础镜像拉取地址

> 注意这个地址需要一个完整可被拉取镜像的地址

##### 示例

:one: nginx镜像

```shell
docker pull nginx:stable
```

那么在**输入栏**中就要输入 `nginx:stable`


:two: dotnet sdk 8.0预览版镜像

```shell
docker pull mcr.microsoft.com/dotnet/sdk:8.0-preview
```

那么在**输入栏**中就要输入 `mcr.microsoft.com/dotnet/sdk:8.0-preview`

#### Step2. 选择代码仓库及分支

![代码仓库](/assets/project_build_step2.png)

:::info
Git地址中可以看到导入到项目中的仓库地址，选择仓库后，`构建分支`将会列出这个代码仓库下的所有分支
:::

#### Step3. 镜像制品设置

![镜像制品](/assets/project_build_step4.png)

:::info Dockerfile
填写代码仓库中的Dockerfile文件路径，含Dockerfile文件名

例如构建go-to-cloud项目时，Dockerfile栏填写 `./Dockerfile`
:::

::: info 制品名称
在制品仓库中显示的镜像名称，不要带tag，比如go-to-cloud-1.2.3，~~不能使用go-to-cloud-1.2.3:latest~~

几种推荐做法：

分支名作为制品名称的一部分，比如go-to-cloud-feature-xxx

项目名作为制品名称的一部分，比如go-to-cloud-1.2.3
:::


:::info 制品仓库
存放构建产物（镜像）的仓库，在`配置环境 - 制品仓库`中配置的仓库会在下拉列表中出现，按实际情况选择即可
:::

## 持续部署


持续部署(`CD`)，在GTC中称为`部署方案`，一个部署方案负责将一个构建计划的产物（镜像）发布至对应的环境中

### 创建部署方案

![创建部署方案](/assets/project_deploy_new.png)

:::details 部署环境
镜像运行的服务器，在`配置环境 - 部署环境`中配置的环境会在下拉列表中出现，按实际情况选择即可
:::

:::details 名字空间
即k8s中的名字空间，一般服务于同一业务的应用会放在同一个名字空间

比如go-to-cloud是由前端(front)和后端(backend)两个应用组成

那我们可以将这两个应用的镜像部署到同一个名字空间(gotocloud)中
:::

:::tip
如果下拉列表中没有符合实际的名字空间，请先确定部署环境是否正确，或者直接在名字空间栏中输入，GTC会自动创建这个名字空间
:::

:::details 镜像名称
用于运行的镜像，会从和项目有关的制品仓库中加载

由于镜像可能会比较多，因此可以在输入栏中**输入关键字进行过滤**
:::

:::details 部署版本
选择镜像后，部署版本中将会加载镜像的历史版本

通常来说，我们会选择`latest`作为部署版本，这样每次构建不用重新选择版本，系统会自动部署最新一次构建的镜像
:::

:::info 其他参数
1. 副本数量：即Pod数量，根据实际情况选择，也可以在完成部署后再调整
2. 端口映射：`服务端口`表示应用本身定义的端口，`容器端口`是指容器对外暴露可被外部访问的端口，通常来说我们会将这两个端口定义为同一个，即`容器端口`跟随`服务端口`
3. 环境变量：为应用设置的环境变量，比如以下代码中就会使用到环境变量`ENV`，这就需要在这一栏参数中配置具体的键值对
::: code-group
```csharp
System.Environment.GetEnvironmentVariable("ENV")
```
```go
os.Env("ENV")
```
4. 资源配置：限制容器可使用的内存和CPU资源，关于资源配置请参阅[k8s的相关介绍](https://kubernetes.io/zh-cn/docs/concepts/configuration/manage-resources-containers/#resource-units-in-kubernetes)
5. 健康检查：k8s检测容器是否可用的接口，默认是`http`类型接口，地址：`healthz`，应当为每个应用都实现这个健康地址，因此这是一个必选项
:::

配置完成后点击`提交`或`提交并部署`即完成方案的创建，选择后者可以立即执行一次部署

### 部署列表
![部署列表](/assets/project_deploy_list.png)

> 创建方案后，可以在列表中看到基本参数，包括部署的`名字空间`，暴露的`端口映射`，镜像名称和版本以及环境变量

列表右侧的`操作`选项可以执行`立即部署`（或者`重新部署`）,查看`部署历史`，`删除部署方案`等操作

:::tip
如果已经部署过，会在`操作`选项中看到一项`转到应用监控`

在应用监控中我们可以伸缩容器的副本、重启服务，查看容器运行日志，甚至进入容器内部执行脚本命令
:::


## 制品仓库

:::tip
与`配置环境 - 制品仓库`类似，区别是只能看到和这个项目相关的镜像制品，并且无法删除制品记录
:::
